<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador de enlaces | LA TARIMA</title>
    <link rel="icon" href="../img/ico.png" type="image/png">
    <link rel="stylesheet" href="../estilos.css">
    <style>
        @media (max-width: 700px) {
            .admin-container {
                max-width: 100vw;
                padding: 0 2vw;
            }
            .admin-table {
                font-size: 0.92em;
                min-width: 420px;
                width: 100%;
                display: block;
                overflow-x: auto;
                box-sizing: border-box;
                border-radius: 8px;
                background: #fff;
            }
            .admin-table thead, .admin-table tbody, .admin-table tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }
            .admin-table th, .admin-table td {
                padding: 6px 2px;
                font-size: 0.95em;
                word-break: break-word;
            }
            .admin-input {
                font-size: 0.98em;
                min-width: 80px;
                max-width: 100vw;
            }
            .download-btn {
                font-size: 0.98em;
                padding: 4px 0;
                top: 8px;
                right: 0;
            }
            .admin-btn {
                font-size: 0.95em;
                padding: 3px 6px;
            }
            h1 {
                font-size: 1.1em;
            }
            #tables {
                width: 100vw;
                overflow-x: auto;
            }
        }
        @media (max-width: 700px) {
            .admin-container {
                max-width: 100vw;
                padding: 0 2vw;
            }
            .admin-table {
                font-size: 0.95em;
                min-width: 500px;
                width: 100%;
                display: block;
                overflow-x: auto;
                box-sizing: border-box;
            }
            .admin-table th, .admin-table td {
                padding: 6px 4px;
                font-size: 0.98em;
            }
            .admin-input {
                font-size: 1em;
                min-width: 120px;
                max-width: 100vw;
            }
            .download-btn {
                font-size: 1em;
                padding: 6px 0;
                top: 8px;
                right: 0;
            }
            .admin-btn {
                font-size: 0.98em;
                padding: 4px 8px;
            }
            h1 {
                font-size: 1.3em;
            }
        }
        body {
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: #fff;
        }
        .admin-container {
            width: 100%;
            max-width: 1200px;
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .admin-table { width: 100%; border-collapse: collapse; margin-bottom: 24px; font-size: 1em; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 5px; text-align: left; }
        .admin-table th { background: #f5f5f5; }
        .admin-input { width: 100%; box-sizing: border-box; }
        .download-btn {
            background: #2e7d32; color: #fff; border: none; padding: 8px 0; width: 1.2em; border-radius: 4px; cursor: pointer; position: fixed; top: 16px; right: 0; z-index: 1000; font-size: 1.1em; writing-mode: vertical-rl; text-align: center; }
        .admin-btn {
            background: #e5e7eb;
            color: #222;
            border: 1px solid #ccc;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            margin-right: 4px;
        }
        .admin-btn.delete {
            background: #ef4444;
            color: #fff;
            border: 1px solid #ef4444;
        }
        .mod-title { cursor:pointer;background:#bae6fd;padding:12px 0;margin-bottom:8px; }
        .collapsed { opacity:0.7; }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1>Administrador de enlaces</h1>
        <label for="modulo-select" style="font-weight:bold;">Módulo:</label>
        <select id="modulo-select" style="margin-bottom:16px;"></select>
        <div id="tables"></div>
        <div id="status"></div>
    </div>
    <button class="download-btn" onclick="downloadLinks()">Descargar Links</button>
    <script type="module">
        // Cargar links reales desde links.json
        let links = {};
        let ordenModulos = [
            'barandas_desmontables',
            'barandas_sommier',
            'barandas_fijas',
            'barandas_ortopedicas',
            'steps_cajones',
            'estantes',
            'deck',
            'fanales',
            'organizadores',
            'percheros',
            'camas',
            'escaleras',
            'infantiles'
        ];
        let moduloActual = ordenModulos[0];
        fetch('./links.json')
            .then(res => res.json())
            .then(data => {
                links = data.modules || {};
                renderSelector();
                renderTables();
            });

        function renderSelector() {
            const select = document.getElementById('modulo-select');
            select.innerHTML = '';
            ordenModulos.forEach(mod => {
                if (Array.isArray(links[mod])) {
                    const opt = document.createElement('option');
                    opt.value = mod;
                    opt.textContent = mod.replace(/_/g,' ').toUpperCase();
                    select.appendChild(opt);
                }
            });
            select.value = moduloActual;
            select.onchange = function() {
                moduloActual = this.value;
                renderTables();
            };
        }

        function renderTables() {
            const container = document.getElementById('tables');
            container.innerHTML = '';
            if (!Array.isArray(links[moduloActual])) return;
            const productos = links[moduloActual];
            const table = document.createElement('table');
            table.className = 'admin-table';
            const thead = document.createElement('thead');
            thead.innerHTML = `<tr><th colspan='5' class='mod-title'>${moduloActual.replace(/_/g,' ').toUpperCase()}</th></tr><tr><th>Modelo</th><th>Medida</th><th>Tipo</th><th>Enlace</th><th>Agregar</th></tr>`;
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            tbody.style.display = '';
            // Agrupar por modelo dinámicamente según el JSON
            const modelosUnicos = [...new Set(productos.map(p => p.modelo))].filter(Boolean);
            modelosUnicos.forEach(modelo => {
                const grupo = productos.filter(p => p.modelo === modelo);
                if (grupo.length) {
                    const trModelo = document.createElement('tr');
                    trModelo.innerHTML = `<td colspan='5' style='background:#dbeafe;font-weight:bold;'>${modelo.toUpperCase()}</td>`;
                    tbody.appendChild(trModelo);
                    // Agrupar por tipo dinámicamente
                    const tiposUnicos = [...new Set(grupo.map(p => p.tipo))].filter(Boolean);
                    tiposUnicos.forEach(tipo => {
                        const subgrupo = grupo.filter(p => p.tipo === tipo);
                        if (subgrupo.length) {
                            const trTipo = document.createElement('tr');
                            trTipo.innerHTML = `<td colspan='5' style='background:#eaeaea;font-weight:bold;'>${tipo.toUpperCase()}</td>`;
                            tbody.appendChild(trTipo);
                            subgrupo.forEach((prod, idx) => {
                                const tr = document.createElement('tr');
                                // Si el enlace está cargado, resaltar el input
                                const hasLink = prod.href && prod.href.trim() && prod.href !== '#';
                                const inputStyle = hasLink ? "background:#d1fae5;border:2px solid #059669;" : "";
                                tr.innerHTML = `<td>${prod.modelo}</td><td>${prod.medida}</td><td>${prod.tipo}</td><td><input class='admin-input' type='text' value='${prod.href}' style='${inputStyle}' data-mod='${moduloActual}' data-idx='${productos.indexOf(prod)}'></td><td><button class='admin-btn' onclick='pasteLink(this, \"${moduloActual}\", ${productos.indexOf(prod)})'>Agregar</button> <button class='admin-btn delete' onclick='deleteLink(\"${moduloActual}\", ${productos.indexOf(prod)}, this)'>B</button> ${hasLink ? `<button class='admin-btn' onclick=\"navigator.clipboard.writeText('${prod.href}')\">Copiar</button> <button class='admin-btn' onclick=\"window.open('${prod.href}','_blank')\">Visitar</button>` : ''}</td>`;
                                tbody.appendChild(tr);
                            });
                        }
                    });
                }
            });
            table.appendChild(tbody);
            container.appendChild(table);
        }

        window.deleteLink = function(mod, idx, btn) {
            links[mod][idx].href = '';
            btn.closest('tr').querySelector('.admin-input').value = '';
            // Guardar estado expandido antes de renderizar
            expandedModules = {};
            document.querySelectorAll('.mod-title').forEach((el, i) => {
                const modName = el.textContent.trim().toLowerCase().replace(/ /g,'_');
                const tbody = el.closest('table').querySelector('tbody');
                expandedModules[modName] = tbody && tbody.style.display !== 'none';
            });
            renderTables();
        }

        window.pasteLink = function(btn, mod, idx) {
            navigator.clipboard.readText().then(text => {
                const input = btn.parentElement.parentElement.querySelector('input');
                input.value = text;
                links[mod][idx].href = text;
            });
        }

        window.downloadLinks = function() {
            const json = JSON.stringify({ modules: links }, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'links.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            document.getElementById('status').textContent = '¡Descarga lista!';
        }

        document.addEventListener('input', e => {
            if (e.target.classList.contains('admin-input')) {
                const mod = e.target.getAttribute('data-mod');
                const idx = e.target.getAttribute('data-idx');
                links[mod][idx].href = e.target.value;
            }
        });

        renderTables();
    </script>
</body>
</html>