<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Principal | LA TARIMA</title>
    <link rel="stylesheet" href="editor.css">
    <link rel="icon" href="../img/ico.png" type="image/png">
</head>
<body>
    <div class="editor-container">
        <a href="../index.html" style="text-decoration:none; color:inherit;">
            <h1>üéØ EDITOR PRINCIPAL - LA TARIMA</h1>
        </a>
        
        <div id="mensaje-status" class="status-message" style="display:none;"></div>
        
        <!-- Informaci√≥n B√°sica del Sitio -->
        <div class="seccion-card">
            <div class="seccion-header">
                <h3 class="seccion-title">üìù Informaci√≥n B√°sica</h3>
            </div>
            <div class="seccion-content">
                <div class="two-column">
                    <div class="form-group">
                        <label>Nombre del Sitio:</label>
                        <input type="text" id="siteName" placeholder="LA TARIMA">
                    </div>
                    <div class="form-group">
                        <label>Subt√≠tulo:</label>
                        <input type="text" id="subtitle" placeholder="Carpinter√≠a Online">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Descripci√≥n SEO:</label>
                    <textarea id="seoDescription" placeholder="Descripci√≥n para motores de b√∫squeda"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Palabras Clave SEO:</label>
                    <input type="text" id="seoKeywords" placeholder="carpinter√≠a, barandas, estantes, etc.">
                </div>
            </div>
        </div>

        <!-- Enlaces Sociales -->
        <div class="seccion-card">
            <div class="seccion-header">
                <h3 class="seccion-title">üåê Enlaces Sociales</h3>
            </div>
            <div class="seccion-content">
                <div id="social-links-container">
                    <!-- Los enlaces sociales se cargan din√°micamente -->
                </div>
                <button class="btn-success" onclick="agregarEnlaceSocial()">+ Agregar Enlace Social</button>
            </div>
        </div>

        <!-- Iconos Flotantes -->
        <div class="seccion-card">
            <div class="seccion-header">
                <h3 class="seccion-title">üéØ Iconos Flotantes</h3>
            </div>
            <div class="seccion-content">
                <div id="floating-icons-container">
                    <div class="empty-message">Los iconos flotantes aparecer√°n aqu√≠...</div>
                </div>
                
                <button class="btn-success" onclick="agregarIconoFlotante()">+ Agregar Icono Flotante</button>
                <button class="btn-primary" onclick="debugIconosFlotantes()" style="margin-left: 10px;">üêõ Debug Iconos</button>
                <button class="btn-warning" onclick="repararIconosFlotantes()" style="margin-left: 10px;">üîß Reparar</button>
                <button class="btn-primary" onclick="testVisualIconos()" style="margin-left: 10px;">üëÅÔ∏è Test Visual</button>
                <button class="btn-success" onclick="window.location.reload()" style="margin-left: 10px;">üîÑ Recargar</button>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #2c3e50;">üí° Consejos:</h4>
                    <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #666;">
                        <li>Los iconos flotantes aparecen en el lateral derecho de la p√°gina</li>
                        <li>Usa im√°genes cuadradas (PNG con transparencia funciona mejor)</li>
                        <li>Las URLs pueden ser p√°ginas internas (ej: calcular.html) o externas (ej: https://...)</li>
                        <li>La posici√≥n determina el orden (1 = arriba, 2 = medio, etc.)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Navegaci√≥n Principal -->
        <div class="seccion-card">
            <div class="seccion-header">
                <h3 class="seccion-title">üß≠ Navegaci√≥n Principal</h3>
            </div>
            <div class="seccion-content">
                <div id="navigation-container">
                    <!-- La navegaci√≥n se carga din√°micamente -->
                </div>
                <button class="btn-success" onclick="agregarBotonNavegacion()">+ Agregar Bot√≥n</button>
            </div>
        </div>

        <!-- Acciones -->
        <div class="actions">
            <button class="btn-primary" onclick="guardarCambios()">üíæ Guardar Cambios</button>
            <button class="btn-success" onclick="actualizarPreview()">üîÑ Actualizar Vista Previa</button>
            <button class="btn-warning" onclick="descargarBackup()">üì• Descargar Backup</button>
            <button class="btn-primary" onclick="diagnosticoCompleto()" style="background: #9b59b6;">üîç Diagn√≥stico Completo</button>
            <a href="../index.html" class="btn-primary">üè† Volver al Sitio</a>
        </div>

        <!-- Vista Previa del JSON -->
        <div class="preview-container">
            <div class="preview-title">Vista Previa del Archivo JSON:</div>
            <div id="json-preview" class="json-preview"></div>
        </div>
    </div>

    <script>
        let datosMain = {};

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, iniciando editor...');
            
            cargarJSON().then(() => {
                console.log('JSON cargado, mostrando interfaz...');
                
                try {
                    mostrarDatos();
                    console.log('Datos b√°sicos mostrados');
                } catch (error) {
                    console.error('Error mostrando datos b√°sicos:', error);
                }
                
                try {
                    mostrarEnlacesSociales();
                    console.log('Enlaces sociales mostrados');
                } catch (error) {
                    console.error('Error mostrando enlaces sociales:', error);
                }
                
                try {
                    mostrarNavegacion();
                    console.log('Navegaci√≥n mostrada');
                } catch (error) {
                    console.error('Error mostrando navegaci√≥n:', error);
                }
                
                try {
                    mostrarIconosFlotantes();
                    console.log('Iconos flotantes mostrados');
                } catch (error) {
                    console.error('Error mostrando iconos flotantes:', error);
                }
                
                console.log('Editor cargado completamente');
            }).catch(error => {
                console.error('Error cargando editor:', error);
                mostrarMensaje('Error cargando el editor: ' + error.message, 'error');
            });
        });

        async function cargarJSON() {
            try {
                console.log('Cargando JSON...');
                const response = await fetch('main-data.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                datosMain = await response.json();
                console.log('JSON cargado exitosamente:', datosMain);
                
                // Asegurar que existe la estructura completa
                if (!datosMain.floatingIcons) {
                    datosMain.floatingIcons = [];
                    console.log('Creada estructura floatingIcons vac√≠a');
                }
                
                if (!datosMain.socialLinks) {
                    datosMain.socialLinks = {};
                    console.log('Creada estructura socialLinks vac√≠a');
                }
                
                if (!datosMain.mainNavigation) {
                    datosMain.mainNavigation = { barandas: { items: [] } };
                    console.log('Creada estructura mainNavigation vac√≠a');
                }
                
                if (!datosMain.seo) {
                    datosMain.seo = { title: "", description: "", keywords: "" };
                    console.log('Creada estructura seo vac√≠a');
                }
                
                return datosMain;
            } catch (error) {
                console.error('Error cargando JSON:', error);
                
                // Crear estructura m√≠nima si falla
                console.log('Creando estructura de datos por defecto...');
                datosMain = {
                    siteName: "LA TARIMA",
                    subtitle: "Carpinter√≠a Online",
                    seo: { 
                        title: "LA TARIMA - Carpinter√≠a", 
                        description: "Carpinter√≠a online especializada en productos de madera", 
                        keywords: "carpinter√≠a, barandas, estantes, madera" 
                    },
                    socialLinks: {
                        whatsapp: "https://wa.me/5491167007723",
                        instagram: "https://www.instagram.com/latarimadecoracion"
                    },
                    floatingIcons: [],
                    mainNavigation: { 
                        barandas: { 
                            title: "Barandas para cama",
                            items: [] 
                        } 
                    }
                };
                
                mostrarMensaje('Usando datos por defecto (no se pudo cargar main-data.json)', 'error');
                return datosMain;
            }
        }

        function mostrarDatos() {
            try {
                console.log('Mostrando datos b√°sicos...');
                
                const siteName = document.getElementById('siteName');
                const subtitle = document.getElementById('subtitle');
                const seoDescription = document.getElementById('seoDescription');
                const seoKeywords = document.getElementById('seoKeywords');
                
                if (siteName) siteName.value = datosMain.siteName || '';
                if (subtitle) subtitle.value = datosMain.subtitle || '';
                if (seoDescription) seoDescription.value = datosMain.seo?.description || '';
                if (seoKeywords) seoKeywords.value = datosMain.seo?.keywords || '';
                
                actualizarPreview();
                console.log('Datos b√°sicos mostrados correctamente');
            } catch (error) {
                console.error('Error mostrando datos:', error);
                mostrarMensaje('Error mostrando datos b√°sicos: ' + error.message, 'error');
            }
        }

        // Funciones para iconos flotantes (globales)
        window.mostrarIconosFlotantes = function() {
            const container = document.getElementById('floating-icons-container');
            if (!container) {
                console.error('No se encontr√≥ el contenedor floating-icons-container');
                return;
            }
            
            container.innerHTML = '';
            
            if (!datosMain.floatingIcons) datosMain.floatingIcons = [];
            
            console.log('Mostrando iconos flotantes:', datosMain.floatingIcons.length);
            
            if (datosMain.floatingIcons.length === 0) {
                container.innerHTML = '<div class="empty-message">No hay iconos flotantes. Haz click en "+ Agregar Icono Flotante" para crear uno.</div>';
                return;
            }
            
            // Ordenar por posici√≥n
            const iconosOrdenados = [...datosMain.floatingIcons].sort((a, b) => (a.position || 1) - (b.position || 1));
            
            iconosOrdenados.forEach((icono, index) => {
                const realIndex = datosMain.floatingIcons.findIndex(i => i.id === icono.id);
                const iconoDiv = document.createElement('div');
                iconoDiv.className = 'navigation-item';
                iconoDiv.innerHTML = `
                    <div class="item-row">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        <strong>Icono Flotante ${icono.position || realIndex + 1}</strong>
                        <button class="btn-danger" onclick="eliminarIconoFlotante(${realIndex})">üóëÔ∏è</button>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Texto del Tooltip:</label>
                            <input type="text" placeholder="Texto al pasar mouse" value="${icono.text || ''}" onchange="actualizarIconoFlotante(${realIndex}, 'text', this.value)">
                        </div>
                        <div class="form-group">
                            <label>URL de Destino:</label>
                            <input type="text" placeholder="pagina.html o https://..." value="${icono.url || ''}" onchange="actualizarIconoFlotante(${realIndex}, 'url', this.value)">
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Imagen del Icono:</label>
                            <input type="text" placeholder="img/mi-icono.png" value="${icono.image || ''}" onchange="actualizarIconoFlotante(${realIndex}, 'image', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Posici√≥n (orden):</label>
                            <input type="number" min="1" max="10" placeholder="1" value="${icono.position || realIndex + 1}" onchange="actualizarIconoFlotante(${realIndex}, 'position', parseInt(this.value) || 1)">
                        </div>
                    </div>
                `;
                container.appendChild(iconoDiv);
            });
        }

        window.agregarIconoFlotante = function() {
            try {
                const nuevoIcono = {
                    id: 'icono-' + Date.now(),
                    text: 'Nuevo Icono',
                    url: '#',
                    image: 'img/icono-carpintero.png',
                    position: (datosMain.floatingIcons?.length || 0) + 1
                };
                
                if (!datosMain.floatingIcons) datosMain.floatingIcons = [];
                datosMain.floatingIcons.push(nuevoIcono);
                
                mostrarIconosFlotantes();
                actualizarPreview();
                mostrarMensaje('Icono flotante agregado correctamente', 'exito');
            } catch (error) {
                console.error('Error agregando icono flotante:', error);
                mostrarMensaje('Error al agregar icono: ' + error.message, 'error');
            }
        }

        window.eliminarIconoFlotante = function(index) {
            try {
                if (confirm('¬øEst√°s seguro de que quieres eliminar este icono flotante?')) {
                    datosMain.floatingIcons.splice(index, 1);
                    mostrarIconosFlotantes();
                    actualizarPreview();
                }
            } catch (error) {
                console.error('Error eliminando icono flotante:', error);
                mostrarMensaje('Error al eliminar icono: ' + error.message, 'error');
            }
        }

        window.actualizarIconoFlotante = function(index, campo, valor) {
            try {
                if (campo === 'position') {
                    datosMain.floatingIcons[index][campo] = valor;
                    mostrarIconosFlotantes(); // Refrescar para reordenar
                } else {
                    datosMain.floatingIcons[index][campo] = valor;
                }
                actualizarPreview();
            } catch (error) {
                console.error('Error actualizando icono flotante:', error);
                mostrarMensaje('Error al actualizar icono: ' + error.message, 'error');
            }
        }

        // Funci√≥n de debug completa
        window.debugIconosFlotantes = function() {
            console.log('=== DEBUG COMPLETO ICONOS FLOTANTES ===');
            
            // 1. Verificar datos
            console.log('1. datosMain existe:', typeof datosMain !== 'undefined');
            console.log('2. datosMain completo:', datosMain);
            console.log('3. datosMain.floatingIcons:', datosMain?.floatingIcons);
            console.log('4. Cantidad de iconos:', datosMain?.floatingIcons?.length || 0);
            
            // 2. Verificar DOM
            const container = document.getElementById('floating-icons-container');
            console.log('5. Contenedor existe:', !!container);
            console.log('6. Contenedor HTML antes:', container?.innerHTML);
            
            // 3. Verificar funciones
            console.log('7. mostrarIconosFlotantes es funci√≥n:', typeof window.mostrarIconosFlotantes);
            console.log('8. agregarIconoFlotante es funci√≥n:', typeof window.agregarIconoFlotante);
            
            // 4. Ejecutar funci√≥n
            try {
                console.log('9. Ejecutando mostrarIconosFlotantes...');
                window.mostrarIconosFlotantes();
                console.log('10. mostrarIconosFlotantes ejecutado correctamente');
                console.log('11. Contenedor HTML despu√©s:', container?.innerHTML);
            } catch (error) {
                console.error('10. ERROR en mostrarIconosFlotantes:', error);
                console.error('11. Stack trace:', error.stack);
            }
            
            // 5. Verificar eventos de botones
            const btnAgregar = document.querySelector('button[onclick="agregarIconoFlotante()"]');
            console.log('12. Bot√≥n agregar existe:', !!btnAgregar);
            
            console.log('=== FIN DEBUG COMPLETO ===');
        }

        // Funci√≥n de reparaci√≥n autom√°tica
        window.repararIconosFlotantes = function() {
            console.log('Intentando reparar iconos flotantes...');
            
            // Verificar y crear estructura m√≠nima si no existe
            if (!datosMain.floatingIcons) {
                datosMain.floatingIcons = [];
            }
            
            // Re-ejecutar mostrarIconosFlotantes
            try {
                window.mostrarIconosFlotantes();
                console.log('‚úÖ Reparaci√≥n completada');
                return true;
            } catch (error) {
                console.error('‚ùå Error en reparaci√≥n:', error);
                return false;
            }
        }
        
        // Funci√≥n de test visual
        window.testVisualIconos = function() {
            const container = document.getElementById('floating-icons-container');
            if (!container) {
                alert('‚ùå Contenedor no encontrado');
                return;
            }
            
            // A√±adir un elemento de prueba visible
            const testDiv = document.createElement('div');
            testDiv.style.cssText = 'background: red !important; color: white !important; padding: 20px !important; margin: 10px !important; border: 2px solid black !important; font-size: 16px !important; font-weight: bold !important;';
            testDiv.innerHTML = 'üî¥ ELEMENTO DE PRUEBA VISIBLE - Si ves esto, el CSS funciona';
            container.appendChild(testDiv);
            
            setTimeout(() => {
                container.removeChild(testDiv);
            }, 3000);
            
            alert('‚úÖ Elemento de prueba a√±adido por 3 segundos');
        }

        // Funci√≥n de diagn√≥stico general
        window.diagnosticoCompleto = function() {
            console.log('=== DIAGN√ìSTICO COMPLETO DEL EDITOR ===');
            
            // 1. Verificar datos
            console.log('1. datosMain:', datosMain);
            console.log('2. Estructura completa:', JSON.stringify(datosMain, null, 2));
            
            // 2. Verificar elementos DOM
            const elementos = [
                'siteName', 'subtitle', 'seoDescription', 'seoKeywords',
                'floating-icons-container', 'social-links-container', 
                'navigation-container', 'json-preview', 'mensaje-status'
            ];
            
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                console.log(`3. Elemento ${id}:`, !!elemento);
            });
            
            // 3. Verificar funciones
            const funciones = [
                'mostrarIconosFlotantes', 'agregarIconoFlotante', 'mostrarDatos',
                'mostrarEnlacesSociales', 'mostrarNavegacion', 'guardarCambios'
            ];
            
            funciones.forEach(func => {
                console.log(`4. Funci√≥n ${func}:`, typeof window[func] || typeof eval(func));
            });
            
            // 4. Verificar CSS
            const computed = getComputedStyle(document.body);
            console.log('5. CSS cargado - color de fondo:', computed.background);
            
            console.log('=== FIN DIAGN√ìSTICO ===');
            
            // Mostrar resumen en alerta
            const resumen = `
                ‚úì Datos: ${datosMain ? 'OK' : 'ERROR'}
                ‚úì Iconos flotantes: ${datosMain.floatingIcons ? datosMain.floatingIcons.length : 0}
                ‚úì Enlaces sociales: ${datosMain.socialLinks ? Object.keys(datosMain.socialLinks).length : 0}
                ‚úì CSS: ${computed.background ? 'Cargado' : 'Error'}
            `;
            alert('Diagn√≥stico completado - Ver consola (F12) para detalles' + resumen);
        }

        // Funciones para enlaces sociales
        function mostrarEnlacesSociales() {
            const container = document.getElementById('social-links-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!datosMain.socialLinks) {
                datosMain.socialLinks = {};
            }
            
            const socialNetworks = ['whatsapp', 'instagram', 'facebook', 'tiktok', 'youtube'];
            
            socialNetworks.forEach(network => {
                const linkDiv = document.createElement('div');
                linkDiv.className = 'form-group';
                linkDiv.innerHTML = `
                    <label>${network.charAt(0).toUpperCase() + network.slice(1)}:</label>
                    <input type="url" placeholder="https://..." value="${datosMain.socialLinks[network] || ''}" 
                           onchange="actualizarEnlaceSocial('${network}', this.value)">
                `;
                container.appendChild(linkDiv);
            });
        }

        function agregarEnlaceSocial() {
            const nombre = prompt('Nombre de la red social:');
            if (nombre) {
                const url = prompt('URL de la red social:');
                if (url) {
                    datosMain.socialLinks[nombre.toLowerCase()] = url;
                    mostrarEnlacesSociales();
                    actualizarPreview();
                }
            }
        }

        function actualizarEnlaceSocial(network, url) {
            datosMain.socialLinks[network] = url;
            actualizarPreview();
        }

        // Funciones para navegaci√≥n
        function mostrarNavegacion() {
            const container = document.getElementById('navigation-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!datosMain.mainNavigation) {
                datosMain.mainNavigation = { barandas: { items: [] } };
            }
            
            if (datosMain.mainNavigation.barandas && datosMain.mainNavigation.barandas.items) {
                datosMain.mainNavigation.barandas.items.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'navigation-item';
                    itemDiv.innerHTML = `
                        <div class="item-row">
                            <strong>Bot√≥n de Navegaci√≥n ${index + 1}</strong>
                            <button class="btn-danger" onclick="eliminarBotonNavegacion(${index})">üóëÔ∏è</button>
                        </div>
                        <div class="two-column">
                            <div class="form-group">
                                <label>T√≠tulo:</label>
                                <input type="text" value="${item.title || ''}" onchange="actualizarBotonNavegacion(${index}, 'title', this.value)">
                            </div>
                            <div class="form-group">
                                <label>URL:</label>
                                <input type="text" value="${item.url || ''}" onchange="actualizarBotonNavegacion(${index}, 'url', this.value)">
                            </div>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });
            }
        }

        function agregarBotonNavegacion() {
            if (!datosMain.mainNavigation) {
                datosMain.mainNavigation = { barandas: { items: [] } };
            }
            if (!datosMain.mainNavigation.barandas) {
                datosMain.mainNavigation.barandas = { items: [] };
            }
            if (!datosMain.mainNavigation.barandas.items) {
                datosMain.mainNavigation.barandas.items = [];
            }
            
            const nuevoBoton = {
                title: 'Nuevo Bot√≥n',
                url: '#',
                id: 'btn-' + Date.now()
            };
            
            datosMain.mainNavigation.barandas.items.push(nuevoBoton);
            mostrarNavegacion();
            actualizarPreview();
        }

        function eliminarBotonNavegacion(index) {
            if (confirm('¬øEliminar este bot√≥n de navegaci√≥n?')) {
                datosMain.mainNavigation.barandas.items.splice(index, 1);
                mostrarNavegacion();
                actualizarPreview();
            }
        }

        function actualizarBotonNavegacion(index, campo, valor) {
            datosMain.mainNavigation.barandas.items[index][campo] = valor;
            actualizarPreview();
        }
        
        function actualizarPreview() {
            document.getElementById('json-preview').textContent = JSON.stringify(datosMain, null, 2);
        }

        function mostrarMensaje(mensaje, tipo) {
            const statusDiv = document.getElementById('mensaje-status');
            statusDiv.textContent = mensaje;
            statusDiv.className = `mensaje ${tipo}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        async function guardarCambios() {
            try {
                // Actualizar datos b√°sicos
                datosMain.siteName = document.getElementById('siteName').value;
                datosMain.subtitle = document.getElementById('subtitle').value;
                datosMain.seo.description = document.getElementById('seoDescription').value;
                datosMain.seo.keywords = document.getElementById('seoKeywords').value;
                
                // Simulaci√≥n de guardado (en un proyecto real aqu√≠ ir√≠a una petici√≥n al servidor)
                console.log('Guardando:', datosMain);
                mostrarMensaje('Cambios guardados correctamente', 'exito');
                actualizarPreview();
            } catch (error) {
                console.error('Error guardando:', error);
                mostrarMensaje('Error al guardar: ' + error.message, 'error');
            }
        }

        function descargarBackup() {
            const dataStr = JSON.stringify(datosMain, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'main-data-backup.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>