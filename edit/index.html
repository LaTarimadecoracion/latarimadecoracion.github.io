<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Principal | LA TARIMA</title>
    <link rel="stylesheet" href="editor.css">
    <link rel="icon" href="../img/ico.png" type="image/png">
</head>
<body>
    <div class="editor-container">
        <a href="../index.html" class="titulo-link">
            <h1>üéØ EDITOR PRINCIPAL - LA TARIMA</h1>
        </a>
        
        <div id="mensaje-status" class="mensaje info">
            üîÑ Cargando editor...
        </div>
        
        <!-- Informaci√≥n B√°sica del Sitio -->
        <div class="seccion-card">
            <div class="seccion-header">
                <h3 class="seccion-title">üìù Informaci√≥n B√°sica</h3>
            </div>
            <div class="seccion-content">
                <div class="two-column">
                    <div class="form-group">
                        <label>Nombre del Sitio:</label>
                        <input type="text" id="siteName" placeholder="LA TARIMA">
                    </div>
                    <div class="form-group">
                        <label>Subt√≠tulo:</label>
                        <input type="text" id="subtitle" placeholder="Carpinter√≠a Online">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Descripci√≥n SEO:</label>
                    <textarea id="seoDescription" placeholder="Descripci√≥n para motores de b√∫squeda"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Palabras Clave SEO:</label>
                    <input type="text" id="seoKeywords" placeholder="carpinter√≠a, barandas, estantes, etc.">
                </div>
            </div>
        </div>

        <!-- Enlaces Sociales -->
        <div class="seccion-card">
            <div class="seccion-header">
                <h3 class="seccion-title">üåê Enlaces Sociales</h3>
            </div>
            <div class="seccion-content">
                <div id="social-links-container">
                    <!-- Los enlaces sociales se cargan din√°micamente -->
                </div>
                <button class="btn-success" onclick="agregarEnlaceSocial()">+ Agregar Enlace Social</button>
            </div>
        </div>

        <!-- Iconos Flotantes -->
        <div class="seccion-card">
            <div class="seccion-header">
                <h3 class="seccion-title">üéØ Iconos Flotantes</h3>
            </div>
            <div class="seccion-content">
                <div id="floating-icons-container">
                    <div class="empty-message">Los iconos flotantes aparecer√°n aqu√≠...</div>
                </div>
                
                <button class="btn-success" onclick="agregarIconoFlotante()">+ Agregar Icono Flotante</button>
                <button class="btn-primary" onclick="debugIconosFlotantes()">üêõ Debug Iconos</button>
                <button class="btn-warning" onclick="repararIconosFlotantes()">üîß Reparar</button>
                <button class="btn-primary" onclick="testVisualIconos()">üëÅÔ∏è Test Visual</button>
                <button class="btn-success" onclick="window.location.reload()">üîÑ Recargar</button>
            </div>
        </div>

        <!-- Navegaci√≥n Principal -->
        <div class="seccion-card">
            <div class="seccion-header">
                <h3 class="seccion-title">üß≠ Navegaci√≥n Principal</h3>
            </div>
            <div class="seccion-content">
                <div id="navigation-container">
                    <!-- La navegaci√≥n se carga din√°micamente -->
                </div>
                <button class="btn-success" onclick="crearMenuDesplegable()">+ Crear Nuevo Men√∫ Desplegable</button>
                <button class="btn-info" onclick="agregarSubMenuAExistente()">+ Agregar Submen√∫ a Men√∫ Existente</button>
                <button class="btn-success" onclick="agregarBotonDirecto()">+ Agregar Bot√≥n Principal</button>
            </div>
        </div>

        <!-- Secci√≥n Nuestras Redes -->
        <div class="seccion-card">
            <div class="seccion-header">
                <h3 class="seccion-title">üì± Secci√≥n "Nuestras Redes"</h3>
            </div>
            <div class="seccion-content">
                <div class="form-group">
                    <label>T√≠tulo de la Secci√≥n:</label>
                    <input type="text" id="social-section-title" placeholder="Nuestras redes" onchange="actualizarTituloSeccionSocial()">
                </div>
                
                <div id="social-section-container">
                    <!-- Las redes sociales se cargan din√°micamente -->
                </div>
                
                <button class="btn-success" onclick="agregarRedSocial()">+ Agregar Red Social</button>
            </div>
        </div>

        <!-- Acciones -->
        <div class="actions">
            <button class="btn-primary" onclick="guardarCambios()">üíæ Guardar Cambios</button>
            <button class="btn-info" onclick="console.log('Datos actuales:', datosMain)">ÔøΩ Ver Datos en Consola</button>
            <button class="btn-warning" onclick="descargarBackup()">ÔøΩ Backup con Timestamp</button>
            <button class="btn-diagnostic" onclick="diagnosticoCompleto()">üîç Diagn√≥stico Completo</button>
            <a href="../index.html" class="btn-primary">üè† Volver al Sitio</a>
        </div>

        <!-- Editor completado - Sin vista previa JSON -->
    </div>

    <script>
        let datosMain = {};

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, iniciando editor...');
            mostrarMensaje('üîÑ Cargando datos...', 'info');
            
            cargarJSON().then(() => {
                console.log('JSON cargado, mostrando interfaz...');
                mostrarMensaje('‚úÖ Datos cargados, construyendo interfaz...', 'info');
                
                try {
                    mostrarDatos();
                    console.log('Datos b√°sicos mostrados');
                } catch (error) {
                    console.error('Error mostrando datos b√°sicos:', error);
                }
                
                try {
                    mostrarEnlacesSociales();
                    console.log('Enlaces sociales mostrados');
                } catch (error) {
                    console.error('Error mostrando enlaces sociales:', error);
                }
                
                try {
                    mostrarNavegacion();
                    console.log('Navegaci√≥n mostrada');
                } catch (error) {
                    console.error('Error mostrando navegaci√≥n:', error);
                }
                
                try {
                    mostrarSeccionSocial();
                    console.log('Secci√≥n social mostrada');
                } catch (error) {
                    console.error('Error mostrando secci√≥n social:', error);
                }
                
                try {
                    mostrarIconosFlotantes();
                    console.log('Iconos flotantes mostrados');
                } catch (error) {
                    console.error('Error mostrando iconos flotantes:', error);
                }
                
                console.log('Editor cargado completamente');
                mostrarMensaje('üéâ Editor cargado correctamente! Todas las secciones est√°n listas.', 'exito');
                
                // Verificar que todas las secciones se cargaron
                setTimeout(() => {
                    const secciones = [
                        { id: 'siteName', nombre: 'Informaci√≥n B√°sica' },
                        { id: 'social-links-container', nombre: 'Enlaces Sociales' },
                        { id: 'floating-icons-container', nombre: 'Iconos Flotantes' },
                        { id: 'navigation-container', nombre: 'Navegaci√≥n' }
                    ];
                    
                    let seccionesCargadas = 0;
                    secciones.forEach(seccion => {
                        const elemento = document.getElementById(seccion.id);
                        if (elemento && (elemento.value || elemento.innerHTML.trim())) {
                            seccionesCargadas++;
                            console.log('‚úÖ Secci√≥n cargada:', seccion.nombre);
                        } else {
                            console.log('‚ùå Secci√≥n vac√≠a:', seccion.nombre);
                        }
                    });
                    
                    console.log(`üìä Secciones cargadas: ${seccionesCargadas}/${secciones.length}`);
                    
                    // Ocultar el mensaje de estado
                    const statusDiv = document.getElementById('mensaje-status');
                    if (statusDiv) {
                        statusDiv.style.display = 'none';
                    }
                }, 2000);
                
            }).catch(error => {
                console.error('Error cargando editor:', error);
                mostrarMensaje('‚ùå Error cargando el editor: ' + error.message, 'error');
            });
        });

        async function cargarJSON() {
            try {
                console.log('Cargando JSON...');
                const response = await fetch('main-data.json');
                
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                
                datosMain = await response.json();
                console.log('JSON cargado exitosamente:', datosMain);
                
                // Asegurar que existe la estructura completa
                if (!datosMain.floatingIcons) {
                    datosMain.floatingIcons = [];
                }
                
                if (!datosMain.socialLinks) {
                    datosMain.socialLinks = {};
                }
                
                if (!datosMain.mainNavigation) {
                    datosMain.mainNavigation = { barandas: { items: [] } };
                }
                
                if (!datosMain.seo) {
                    datosMain.seo = { title: "", description: "", keywords: "" };
                }
                
                return datosMain;
            } catch (error) {
                console.error('Error cargando JSON:', error);
                
                // Crear estructura m√≠nima si falla
                datosMain = {
                    siteName: "LA TARIMA",
                    subtitle: "Carpinter√≠a Online",
                    seo: { 
                        title: "LA TARIMA - Carpinter√≠a", 
                        description: "Carpinter√≠a online especializada en productos de madera", 
                        keywords: "carpinter√≠a, barandas, estantes, madera" 
                    },
                    socialLinks: {
                        whatsapp: "https://wa.me/5491167007723",
                        instagram: "https://www.instagram.com/latarimadecoracion"
                    },
                    floatingIcons: [],
                    mainNavigation: {
                        dropdownMenus: [
                            {
                                id: "barandas",
                                title: "Barandas para cama",
                                items: []
                            }
                        ],
                        directButtons: []
                    }
                };
                
                mostrarMensaje('Usando datos por defecto (no se pudo cargar main-data.json)', 'error');
                return datosMain;
            }
        }

        function mostrarDatos() {
            try {
                console.log('Mostrando datos b√°sicos...');
                
                const siteName = document.getElementById('siteName');
                const subtitle = document.getElementById('subtitle');
                const seoDescription = document.getElementById('seoDescription');
                const seoKeywords = document.getElementById('seoKeywords');
                
                if (siteName) siteName.value = datosMain.siteName || '';
                if (subtitle) subtitle.value = datosMain.subtitle || '';
                if (seoDescription) seoDescription.value = datosMain.seo?.description || '';
                if (seoKeywords) seoKeywords.value = datosMain.seo?.keywords || '';
                
                const socialSectionTitle = document.getElementById('social-section-title');
                if (socialSectionTitle) socialSectionTitle.value = datosMain.socialSection?.title || 'Nuestras redes';
                
                actualizarPreview();
                console.log('Datos b√°sicos mostrados correctamente');
            } catch (error) {
                console.error('Error mostrando datos:', error);
            }
        }

        // Funciones para iconos flotantes
        window.mostrarIconosFlotantes = function() {
            const container = document.getElementById('floating-icons-container');
            if (!container) {
                console.error('No se encontr√≥ el contenedor floating-icons-container');
                return;
            }
            
            container.innerHTML = '';
            
            if (!datosMain.floatingIcons) datosMain.floatingIcons = [];
            
            console.log('Mostrando iconos flotantes:', datosMain.floatingIcons.length);
            
            if (datosMain.floatingIcons.length === 0) {
                container.innerHTML = '<div class="empty-message">No hay iconos flotantes. Haz click en "+ Agregar Icono Flotante" para crear uno.</div>';
                return;
            }
            
            // Ordenar por posici√≥n
            const iconosOrdenados = [...datosMain.floatingIcons].sort((a, b) => (a.position || 1) - (b.position || 1));
            
            iconosOrdenados.forEach((icono, index) => {
                const realIndex = datosMain.floatingIcons.findIndex(i => i.id === icono.id);
                const iconoDiv = document.createElement('div');
                iconoDiv.className = 'navigation-item';
                iconoDiv.innerHTML = `
                    <div class="item-row">
                        <strong>Icono Flotante ${icono.position || realIndex + 1}</strong>
                        <div class="order-controls">
                            <button class="btn-small" onclick="moverIconoFlotante(${realIndex}, 'up')" ${realIndex === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                            <button class="btn-small" onclick="moverIconoFlotante(${realIndex}, 'down')" ${realIndex === datosMain.floatingIcons.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è</button>
                            <button class="btn-danger" onclick="eliminarIconoFlotante(${realIndex})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Texto del Tooltip:</label>
                            <input type="text" placeholder="Texto al pasar mouse" value="${icono.text || ''}" onchange="actualizarIconoFlotante(${realIndex}, 'text', this.value)">
                        </div>
                        <div class="form-group">
                            <label>URL de Destino:</label>
                            <input type="text" placeholder="pagina.html o https://..." value="${icono.url || ''}" onchange="actualizarIconoFlotante(${realIndex}, 'url', this.value)">
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Imagen del Icono:</label>
                            <input type="text" placeholder="img/mi-icono.png" value="${icono.image || ''}" onchange="actualizarIconoFlotante(${realIndex}, 'image', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Posici√≥n (orden):</label>
                            <input type="number" min="1" max="10" placeholder="1" value="${icono.position || realIndex + 1}" onchange="actualizarIconoFlotante(${realIndex}, 'position', parseInt(this.value) || 1)">
                        </div>
                    </div>
                `;
                container.appendChild(iconoDiv);
            });
        }

        window.agregarIconoFlotante = function() {
            try {
                const nuevoIcono = {
                    id: 'icono-' + Date.now(),
                    text: 'Nuevo Icono',
                    url: '#',
                    image: 'img/icono-carpintero.png',
                    position: (datosMain.floatingIcons?.length || 0) + 1
                };
                
                if (!datosMain.floatingIcons) datosMain.floatingIcons = [];
                datosMain.floatingIcons.push(nuevoIcono);
                
                mostrarIconosFlotantes();
                actualizarPreview();
                mostrarMensaje('Icono flotante agregado correctamente', 'exito');
            } catch (error) {
                console.error('Error agregando icono flotante:', error);
                mostrarMensaje('Error al agregar icono: ' + error.message, 'error');
            }
        }

        window.eliminarIconoFlotante = function(index) {
            try {
                if (confirm('¬øEst√°s seguro de que quieres eliminar este icono flotante?')) {
                    datosMain.floatingIcons.splice(index, 1);
                    mostrarIconosFlotantes();
                    actualizarPreview();
                }
            } catch (error) {
                console.error('Error eliminando icono flotante:', error);
            }
        }

        window.actualizarIconoFlotante = function(index, campo, valor) {
            try {
                if (campo === 'position') {
                    datosMain.floatingIcons[index][campo] = valor;
                    mostrarIconosFlotantes(); // Refrescar para reordenar
                } else {
                    datosMain.floatingIcons[index][campo] = valor;
                }
                actualizarPreview();
            } catch (error) {
                console.error('Error actualizando icono flotante:', error);
            }
        }

        // Funciones para enlaces sociales
        function mostrarEnlacesSociales() {
            const container = document.getElementById('social-links-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!datosMain.socialLinks) {
                datosMain.socialLinks = {};
            }
            
            const socialNetworks = ['whatsapp', 'instagram', 'facebook', 'tiktok', 'youtube'];
            
            socialNetworks.forEach(network => {
                const linkDiv = document.createElement('div');
                linkDiv.className = 'form-group';
                linkDiv.innerHTML = `
                    <label>${network.charAt(0).toUpperCase() + network.slice(1)}:</label>
                    <input type="url" placeholder="https://..." value="${datosMain.socialLinks[network] || ''}" 
                           onchange="actualizarEnlaceSocial('${network}', this.value)">
                `;
                container.appendChild(linkDiv);
            });
        }

        function agregarEnlaceSocial() {
            const nombre = prompt('Nombre de la red social:');
            if (nombre) {
                const url = prompt('URL de la red social:');
                if (url) {
                    datosMain.socialLinks[nombre.toLowerCase()] = url;
                    mostrarEnlacesSociales();
                    actualizarPreview();
                }
            }
        }

        function actualizarEnlaceSocial(network, url) {
            datosMain.socialLinks[network] = url;
            actualizarPreview();
        }

        // Funciones para navegaci√≥n
        function mostrarNavegacion() {
            const container = document.getElementById('navigation-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Migrar estructura antigua si existe
            if (!datosMain.mainNavigation) {
                datosMain.mainNavigation = {
                    dropdownMenus: [
                        {
                            id: "barandas",
                            title: "Barandas para cama",
                            items: []
                        }
                    ],
                    directButtons: []
                };
            }
            
            // Migraci√≥n de estructura antigua
            if (datosMain.mainNavigation.barandas && !datosMain.mainNavigation.dropdownMenus) {
                datosMain.mainNavigation.dropdownMenus = [
                    {
                        id: "barandas",
                        title: "Barandas para cama",
                        items: datosMain.mainNavigation.barandas.items || []
                    }
                ];
                delete datosMain.mainNavigation.barandas;
            }
            
            // Mostrar men√∫s desplegables
            if (datosMain.mainNavigation.dropdownMenus && datosMain.mainNavigation.dropdownMenus.length > 0) {
                datosMain.mainNavigation.dropdownMenus.forEach((menu, menuIndex) => {
                    const dropdownTitle = document.createElement('div');
                    dropdownTitle.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0;">
                            <h4>üîΩ Men√∫ Desplegable "${menu.title}"</h4>
                            <button class="btn-danger" onclick="eliminarMenuDesplegable(${menuIndex})" title="Eliminar men√∫ completo">üóëÔ∏è</button>
                        </div>
                    `;
                    container.appendChild(dropdownTitle);
                    
                    menu.items.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'navigation-item';
                    itemDiv.innerHTML = `
                        <div class="item-row">
                            <strong>${menu.title} - Submen√∫ ${index + 1}</strong>
                            <button class="btn-danger" onclick="eliminarSubMenu(${menuIndex}, ${index})">üóëÔ∏è</button>
                        </div>
                        <div class="two-column">
                            <div class="form-group">
                                <label>T√≠tulo:</label>
                                <input type="text" value="${item.title || ''}" onchange="actualizarSubMenu(${menuIndex}, ${index}, 'title', this.value)">
                            </div>
                            <div class="form-group">
                                <label>URL:</label>
                                <input type="text" value="${item.url || ''}" onchange="actualizarSubMenu(${menuIndex}, ${index}, 'url', this.value)">
                            </div>
                        </div>
                    `;
                        container.appendChild(itemDiv);
                    });
                });
            }
            
            // Mostrar botones directos de navegaci√≥n
            if (datosMain.mainNavigation.directButtons && datosMain.mainNavigation.directButtons.length > 0) {
                const buttonsTitle = document.createElement('div');
                buttonsTitle.innerHTML = '<h4 style="margin-top: 20px;">üîó Botones de Navegaci√≥n Principal</h4>';
                container.appendChild(buttonsTitle);
                
                datosMain.mainNavigation.directButtons.forEach((button, index) => {
                    const buttonDiv = document.createElement('div');
                    buttonDiv.className = 'navigation-item';
                    buttonDiv.innerHTML = `
                        <div class="item-row">
                            <strong>Bot√≥n Principal ${index + 1}</strong>
                            <button class="btn-danger" onclick="eliminarBotonDirecto(${index})">üóëÔ∏è</button>
                        </div>
                        <div class="two-column">
                            <div class="form-group">
                                <label>Texto del Bot√≥n:</label>
                                <input type="text" value="${button.title || ''}" onchange="actualizarBotonDirecto(${index}, 'title', this.value)">
                            </div>
                            <div class="form-group">
                                <label>URL:</label>
                                <input type="text" value="${button.url || ''}" onchange="actualizarBotonDirecto(${index}, 'url', this.value)">
                            </div>
                        </div>
                    `;
                    container.appendChild(buttonDiv);
                });
            }
            
            // Compatibilidad con estructura antigua
            if (datosMain.navigationButtons && datosMain.navigationButtons.length > 0) {
                const buttonsTitle = document.createElement('div');
                buttonsTitle.innerHTML = '<h4 style="margin-top: 20px;">üîó Botones de Navegaci√≥n Principal</h4>';
                container.appendChild(buttonsTitle);
                
                datosMain.navigationButtons.forEach((button, index) => {
                    const buttonDiv = document.createElement('div');
                    buttonDiv.className = 'navigation-item';
                    buttonDiv.innerHTML = `
                        <div class="item-row">
                            <strong>Bot√≥n Principal ${index + 1} - ${button.title}</strong>
                            <div class="order-controls">
                                <button class="btn-small" onclick="moverBotonPrincipal(${index}, 'up')" ${index === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                                <button class="btn-small" onclick="moverBotonPrincipal(${index}, 'down')" ${index === datosMain.navigationButtons.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è</button>
                                <button class="btn-danger" onclick="eliminarBotonPrincipal(${index})">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="two-column">
                            <div class="form-group">
                                <label>T√≠tulo:</label>
                                <input type="text" value="${button.title || ''}" onchange="actualizarBotonPrincipal(${index}, 'title', this.value)">
                            </div>
                            <div class="form-group">
                                <label>URL:</label>
                                <input type="text" value="${button.url || ''}" onchange="actualizarBotonPrincipal(${index}, 'url', this.value)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Icono URL:</label>
                            <input type="text" value="${button.icon || ''}" onchange="actualizarBotonPrincipal(${index}, 'icon', this.value)">
                        </div>
                    `;
                    container.appendChild(buttonDiv);
                });
            }
        }

        // Funciones para men√∫s desplegables
        function crearMenuDesplegable() {
            const titulo = prompt('¬øC√≥mo se llamar√° el nuevo men√∫ desplegable?', 'Nuevo Men√∫');
            if (!titulo) return;
            
            if (!datosMain.mainNavigation) {
                datosMain.mainNavigation = { dropdownMenus: [], directButtons: [] };
            }
            if (!datosMain.mainNavigation.dropdownMenus) {
                datosMain.mainNavigation.dropdownMenus = [];
            }
            
            const nuevoMenu = {
                id: 'menu-' + Date.now(),
                title: titulo,
                items: []
            };
            
            datosMain.mainNavigation.dropdownMenus.push(nuevoMenu);
            mostrarNavegacion();
            actualizarPreview();
            mostrarMensaje(`Men√∫ desplegable "${titulo}" creado correctamente`, 'exito');
        }

        function agregarSubMenuAExistente() {
            if (!datosMain.mainNavigation?.dropdownMenus || datosMain.mainNavigation.dropdownMenus.length === 0) {
                alert('Primero debes crear un men√∫ desplegable');
                return;
            }
            
            let opciones = 'Selecciona el men√∫ al que agregar el submen√∫:\n\n';
            datosMain.mainNavigation.dropdownMenus.forEach((menu, index) => {
                opciones += `${index + 1}. ${menu.title}\n`;
            });
            
            const seleccion = prompt(opciones + '\nEscribe el n√∫mero del men√∫:');
            const menuIndex = parseInt(seleccion) - 1;
            
            if (isNaN(menuIndex) || menuIndex < 0 || menuIndex >= datosMain.mainNavigation.dropdownMenus.length) {
                alert('Selecci√≥n inv√°lida');
                return;
            }
            
            const nuevoSubMenu = {
                title: 'Nuevo Submen√∫',
                url: '#',
                id: 'submenu-' + Date.now()
            };
            
            datosMain.mainNavigation.dropdownMenus[menuIndex].items.push(nuevoSubMenu);
            mostrarNavegacion();
            actualizarPreview();
            mostrarMensaje('Submen√∫ agregado correctamente', 'exito');
        }

        function eliminarMenuDesplegable(menuIndex) {
            const menu = datosMain.mainNavigation.dropdownMenus[menuIndex];
            if (confirm(`¬øEliminar completamente el men√∫ "${menu.title}" y todos sus submen√∫s?`)) {
                datosMain.mainNavigation.dropdownMenus.splice(menuIndex, 1);
                mostrarNavegacion();
                actualizarPreview();
                mostrarMensaje('Men√∫ eliminado correctamente', 'exito');
            }
        }

        function eliminarSubMenu(menuIndex, itemIndex) {
            if (confirm('¬øEliminar este submen√∫?')) {
                datosMain.mainNavigation.dropdownMenus[menuIndex].items.splice(itemIndex, 1);
                mostrarNavegacion();
                actualizarPreview();
            }
        }

        function actualizarSubMenu(menuIndex, itemIndex, campo, valor) {
            datosMain.mainNavigation.dropdownMenus[menuIndex].items[itemIndex][campo] = valor;
            actualizarPreview();
        }

        // Funciones para botones directos
        function agregarBotonDirecto() {
            if (!datosMain.mainNavigation) {
                datosMain.mainNavigation = { dropdownMenus: [], directButtons: [] };
            }
            if (!datosMain.mainNavigation.directButtons) {
                datosMain.mainNavigation.directButtons = [];
            }
            
            const nuevoBoton = {
                title: 'Nuevo Bot√≥n',
                url: '#',
                id: 'direct-btn-' + Date.now()
            };
            
            datosMain.mainNavigation.directButtons.push(nuevoBoton);
            mostrarNavegacion();
            actualizarPreview();
            mostrarMensaje('Bot√≥n principal agregado correctamente', 'exito');
        }

        function eliminarBotonDirecto(index) {
            if (confirm('¬øEliminar este bot√≥n principal?')) {
                datosMain.mainNavigation.directButtons.splice(index, 1);
                mostrarNavegacion();
                actualizarPreview();
            }
        }

        function actualizarBotonDirecto(index, campo, valor) {
            datosMain.mainNavigation.directButtons[index][campo] = valor;
            actualizarPreview();
        }

        // Funciones para botones principales (compatibilidad)
        function agregarBotonPrincipal() {
            if (!datosMain.navigationButtons) {
                datosMain.navigationButtons = [];
            }
            
            const nuevoBoton = {
                title: 'Nuevo Bot√≥n Principal',
                url: '#',
                id: 'btn-' + Date.now(),
                icon: 'https://cdn-icons-png.flaticon.com/512/69/69524.png'
            };
            
            datosMain.navigationButtons.push(nuevoBoton);
            mostrarNavegacion();
            actualizarPreview();
        }

        function eliminarBotonPrincipal(index) {
            if (confirm('¬øEliminar este bot√≥n principal?')) {
                datosMain.navigationButtons.splice(index, 1);
                mostrarNavegacion();
                actualizarPreview();
            }
        }

        function actualizarBotonPrincipal(index, campo, valor) {
            if (!datosMain.navigationButtons) {
                datosMain.navigationButtons = [];
            }
            if (datosMain.navigationButtons[index]) {
                datosMain.navigationButtons[index][campo] = valor;
                actualizarPreview();
            }
        }

        // Funciones para secci√≥n social
        function mostrarSeccionSocial() {
            const container = document.getElementById('social-section-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!datosMain.socialSection) {
                datosMain.socialSection = { title: 'Nuestras redes', links: [] };
            }
            
            if (!datosMain.socialSection.links) {
                datosMain.socialSection.links = [];
            }
            
            datosMain.socialSection.links.forEach((link, index) => {
                const linkDiv = document.createElement('div');
                linkDiv.className = 'navigation-item';
                linkDiv.innerHTML = `
                    <div class="item-row">
                        <strong>Red Social ${index + 1} - ${link.name}</strong>
                        <div class="order-controls">
                            <button class="btn-small" onclick="moverRedSocial(${index}, 'up')" ${index === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                            <button class="btn-small" onclick="moverRedSocial(${index}, 'down')" ${index === datosMain.socialSection.links.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è</button>
                            <button class="btn-danger" onclick="eliminarRedSocial(${index})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>Nombre:</label>
                            <input type="text" value="${link.name || ''}" onchange="actualizarRedSocial(${index}, 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Texto a Mostrar:</label>
                            <input type="text" value="${link.displayText || ''}" onchange="actualizarRedSocial(${index}, 'displayText', this.value)">
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label>URL:</label>
                            <input type="text" value="${link.url || ''}" onchange="actualizarRedSocial(${index}, 'url', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Color:</label>
                            <input type="color" value="${link.color || '#000000'}" onchange="actualizarRedSocial(${index}, 'color', this.value)">
                        </div>
                    </div>
                `;
                container.appendChild(linkDiv);
            });
        }

        function agregarRedSocial() {
            if (!datosMain.socialSection) {
                datosMain.socialSection = { title: 'Nuestras redes', links: [] };
            }
            if (!datosMain.socialSection.links) {
                datosMain.socialSection.links = [];
            }
            
            const nuevaRed = {
                name: 'Nueva Red',
                url: '#',
                displayText: 'Nueva Red',
                color: '#000000'
            };
            
            datosMain.socialSection.links.push(nuevaRed);
            mostrarSeccionSocial();
            actualizarPreview();
        }

        function eliminarRedSocial(index) {
            if (confirm('¬øEliminar esta red social?')) {
                datosMain.socialSection.links.splice(index, 1);
                mostrarSeccionSocial();
                actualizarPreview();
            }
        }

        function actualizarRedSocial(index, campo, valor) {
            if (!datosMain.socialSection || !datosMain.socialSection.links) {
                return;
            }
            if (datosMain.socialSection.links[index]) {
                datosMain.socialSection.links[index][campo] = valor;
                actualizarPreview();
            }
        }

        // Actualizar t√≠tulo de secci√≥n social
        function actualizarTituloSeccionSocial() {
            const input = document.getElementById('social-section-title');
            if (input && datosMain.socialSection) {
                datosMain.socialSection.title = input.value;
                actualizarPreview();
            }
        }

        // Funciones de reordenamiento
        function moverRedSocial(index, direction) {
            if (!datosMain.socialSection || !datosMain.socialSection.links) return;
            
            const links = datosMain.socialSection.links;
            if (direction === 'up' && index > 0) {
                [links[index], links[index - 1]] = [links[index - 1], links[index]];
            } else if (direction === 'down' && index < links.length - 1) {
                [links[index], links[index + 1]] = [links[index + 1], links[index]];
            }
            
            mostrarSeccionSocial();
            actualizarPreview();
        }

        function moverBotonPrincipal(index, direction) {
            if (!datosMain.navigationButtons) return;
            
            const buttons = datosMain.navigationButtons;
            if (direction === 'up' && index > 0) {
                [buttons[index], buttons[index - 1]] = [buttons[index - 1], buttons[index]];
            } else if (direction === 'down' && index < buttons.length - 1) {
                [buttons[index], buttons[index + 1]] = [buttons[index + 1], buttons[index]];
            }
            
            mostrarNavegacion();
            actualizarPreview();
        }

        function moverIconoFlotante(index, direction) {
            if (!datosMain.floatingIcons) return;
            
            const icons = datosMain.floatingIcons;
            if (direction === 'up' && index > 0) {
                [icons[index], icons[index - 1]] = [icons[index - 1], icons[index]];
                // Actualizar positions
                icons[index].position = index + 1;
                icons[index - 1].position = index;
            } else if (direction === 'down' && index < icons.length - 1) {
                [icons[index], icons[index + 1]] = [icons[index + 1], icons[index]];
                // Actualizar positions
                icons[index].position = index + 1;
                icons[index + 1].position = index + 2;
            }
            
            mostrarIconosFlotantes();
            actualizarPreview();
        }

        // Funciones de debug
        window.debugIconosFlotantes = function() {
            console.log('=== DEBUG ICONOS FLOTANTES ===');
            console.log('datosMain:', datosMain);
            console.log('floatingIcons:', datosMain.floatingIcons);
            console.log('Cantidad:', datosMain.floatingIcons?.length || 0);
            
            const container = document.getElementById('floating-icons-container');
            console.log('Container:', container);
            
            try {
                mostrarIconosFlotantes();
                console.log('mostrarIconosFlotantes ejecutado correctamente');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        window.repararIconosFlotantes = function() {
            if (!datosMain.floatingIcons) {
                datosMain.floatingIcons = [];
            }
            mostrarIconosFlotantes();
            console.log('Iconos flotantes reparados');
        }

        window.testVisualIconos = function() {
            const container = document.getElementById('floating-icons-container');
            if (!container) {
                alert('‚ùå Contenedor no encontrado');
                return;
            }
            
            const testDiv = document.createElement('div');
            testDiv.style.cssText = 'background: red !important; color: white !important; padding: 20px !important; margin: 10px !important; border: 2px solid black !important; font-size: 16px !important; font-weight: bold !important;';
            testDiv.innerHTML = 'üî¥ ELEMENTO DE PRUEBA VISIBLE - Si ves esto, el CSS funciona';
            container.appendChild(testDiv);
            
            setTimeout(() => {
                if (container.contains(testDiv)) {
                    container.removeChild(testDiv);
                }
            }, 3000);
            
            alert('‚úÖ Elemento de prueba a√±adido por 3 segundos');
        }

        window.diagnosticoCompleto = function() {
            console.log('=== DIAGN√ìSTICO COMPLETO ===');
            console.log('1. datosMain:', datosMain);
            console.log('2. floatingIcons:', datosMain.floatingIcons?.length || 0);
            console.log('3. socialLinks:', Object.keys(datosMain.socialLinks || {}).length);
            console.log('4. mainNavigation:', datosMain.mainNavigation?.barandas?.items?.length || 0);
            
            const elementos = ['siteName', 'floating-icons-container', 'social-links-container', 'navigation-container'];
            elementos.forEach(id => {
                console.log('Elemento ' + id + ':', !!document.getElementById(id));
            });
            
            alert('Diagn√≥stico completado - Ver consola (F12) para detalles');
        }

        function actualizarPreview() {
            // Funci√≥n mantenida para compatibilidad con llamadas existentes
            console.log('Datos actualizados:', datosMain);
        }

        function mostrarMensaje(mensaje, tipo) {
            const statusDiv = document.getElementById('mensaje-status');
            if (statusDiv) {
                statusDiv.textContent = mensaje;
                statusDiv.className = 'mensaje ' + tipo;
                statusDiv.style.display = 'block';
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        async function guardarCambios() {
            try {
                // Actualizar datos b√°sicos
                const siteName = document.getElementById('siteName');
                const subtitle = document.getElementById('subtitle');
                const seoDescription = document.getElementById('seoDescription');
                const seoKeywords = document.getElementById('seoKeywords');
                const socialSectionTitle = document.getElementById('social-section-title');
                
                if (siteName) datosMain.siteName = siteName.value;
                if (subtitle) datosMain.subtitle = subtitle.value;
                if (seoDescription) datosMain.seo.description = seoDescription.value;
                if (seoKeywords) datosMain.seo.keywords = seoKeywords.value;
                if (socialSectionTitle && datosMain.socialSection) {
                    datosMain.socialSection.title = socialSectionTitle.value;
                }
                
                console.log('Guardando datos:', datosMain);
                
                // Descargar el archivo JSON actualizado
                const dataStr = JSON.stringify(datosMain, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'main-data.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                mostrarMensaje('‚úÖ Archivo JSON descargado correctamente como "main-data.json"', 'exito');
                actualizarPreview();
            } catch (error) {
                console.error('Error guardando:', error);
                mostrarMensaje('‚ùå Error al guardar: ' + error.message, 'error');
            }
        }

        function descargarBackup() {
            try {
                const fechaHora = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const dataStr = JSON.stringify(datosMain, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `main-data-backup-${fechaHora}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                mostrarMensaje(`üìÑ Backup creado: main-data-backup-${fechaHora}.json`, 'exito');
            } catch (error) {
                console.error('Error creando backup:', error);
                mostrarMensaje('‚ùå Error al crear backup: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>